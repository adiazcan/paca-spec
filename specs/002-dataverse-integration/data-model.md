# Data Model: Dataverse Integration & Environment Data Strategy

## Overview

This data model defines the Dataverse custom tables that back the Event Approval Workflow application. Cost fields are embedded directly on the request table (no separate `CostEstimate` entity). All CRUD operations are performed through Power Apps SDK generated services, not raw Dataverse Web API calls. The same `IDataProvider` interface used by the `MockDataProvider` is implemented by `DataverseDataProvider`, which wraps the generated services.

## Dataverse Table Prefix

All custom tables use the publisher prefix `paca_`.

## Entities

### 1) EventApprovalRequest — `paca_eventapprovalrequest`

| Column (Logical Name)             | Dataverse Type       | App Type              | Required | Notes                                        |
|-----------------------------------|----------------------|-----------------------|----------|----------------------------------------------|
| `paca_eventapprovalrequestid`     | Uniqueidentifier (PK)| `string` (UUID)       | Auto     | Primary key                                  |
| `paca_requestnumber`              | String (100)         | `string`              | Yes      | Human-readable ID (e.g., `EA-1001`). Generated by the `DataverseDataProvider` using format `EA-{timestamp}{random}` (e.g., `EA-20260216-A3F`) to ensure uniqueness under concurrent submissions without requiring a Dataverse auto-number column. |
| `paca_submitterid`                | String (100)         | `string`              | Yes      | Entra ID user object ID                      |
| `paca_submitterdisplayname`       | String (200)         | `string`              | Yes      | Display name from Entra ID                   |
| `paca_eventname`                  | String (200)         | `string`              | Yes      | 3–200 chars                                  |
| `paca_eventwebsite`               | String (500)         | `string`              | Yes      | URL, https preferred                         |
| `paca_role`                       | Choice               | `RoleType`            | Yes      | `speaker=0, organizer=1, assistant=2`        |
| `paca_transportationmode`         | Choice               | `TransportationMode`  | Yes      | `air=0, rail=1, car=2, bus=3, other=4`       |
| `paca_origin`                     | String (150)         | `string`              | Yes      | Departure location                           |
| `paca_destination`                | String (150)         | `string`              | Yes      | Arrival location                             |
| `paca_status`                     | Choice               | `RequestStatus`       | Yes      | `draft=0, submitted=1, approved=2, rejected=3`|
| `paca_registrationfee`            | Currency             | `number`              | Yes      | >= 0, decimal(12,2)                          |
| `paca_travelcost`                 | Currency             | `number`              | Yes      | >= 0, decimal(12,2)                          |
| `paca_hotelcost`                  | Currency             | `number`              | Yes      | >= 0, decimal(12,2)                          |
| `paca_mealscost`                  | Currency             | `number`              | Yes      | >= 0, decimal(12,2)                          |
| `paca_otherexpenses`              | Currency             | `number`              | Yes      | >= 0, decimal(12,2)                          |
| `paca_currencycode`               | String (3)           | `string`              | Yes      | ISO 4217                                     |
| `paca_totalcost`                  | Currency             | `number`              | Yes      | Computed: sum of cost categories              |
| `paca_submittedat`                | DateTime             | `string \| null`      | No       | Nullable until submit                        |
| `paca_version`                    | Whole Number         | `number`              | Yes      | Optimistic concurrency control, starts at 1  |
| `createdon`                       | DateTime (system)    | `string`              | Auto     | Maps to `createdAt`                          |
| `modifiedon`                      | DateTime (system)    | `string`              | Auto     | Maps to `updatedAt`                          |

### 2) ApprovalDecision — `paca_approvaldecision`

| Column (Logical Name)             | Dataverse Type       | App Type              | Required | Notes                                        |
|-----------------------------------|----------------------|-----------------------|----------|----------------------------------------------|
| `paca_approvaldecisionid`         | Uniqueidentifier (PK)| `string` (UUID)       | Auto     | Primary key                                  |
| `paca_requestid`                  | Lookup               | `string` (UUID)       | Yes      | FK → `paca_eventapprovalrequest`             |
| `paca_approverid`                 | String (100)         | `string`              | Yes      | Entra ID user object ID                      |
| `paca_approverdisplayname`        | String (200)         | `string`              | Yes      | Display name from Entra ID                   |
| `paca_decisiontype`               | Choice               | `DecisionType`        | Yes      | `approved=0, rejected=1`                     |
| `paca_comment`                    | Multiline (2000)     | `string`              | Yes      | 1–2000 chars                                 |
| `paca_decidedat`                  | DateTime             | `string`              | Yes      | When the decision was recorded               |

### 3) RequestHistoryEntry — `paca_requesthistoryentry`

| Column (Logical Name)             | Dataverse Type       | App Type              | Required | Notes                                        |
|-----------------------------------|----------------------|-----------------------|----------|----------------------------------------------|
| `paca_requesthistoryentryid`      | Uniqueidentifier (PK)| `string` (UUID)       | Auto     | Primary key                                  |
| `paca_requestid`                  | Lookup               | `string` (UUID)       | Yes      | FK → `paca_eventapprovalrequest`             |
| `paca_eventtype`                  | Choice               | `HistoryEventType`    | Yes      | `submitted=0, approved=1, rejected=2, commented=3, notification_sent=4, stale_detected=5` |
| `paca_actorid`                    | String (100)         | `string`              | Yes      | User or system ID                            |
| `paca_actorrole`                  | Choice               | `ActorRole`           | Yes      | `employee=0, approver=1, system=2`           |
| `paca_comment`                    | Multiline (2000)     | `string`              | No       | Optional                                     |
| `paca_metadata`                   | Multiline (4000)     | `Record<string,unknown>`| No     | Serialized as JSON string                    |
| `paca_occurredat`                 | DateTime             | `string`              | Yes      | When the event occurred                      |

**Rules**: Immutable after insert. Updates and deletes are prohibited by Dataverse security role configuration.

### 4) StatusNotification — `paca_statusnotification`

| Column (Logical Name)             | Dataverse Type       | App Type              | Required | Notes                                        |
|-----------------------------------|----------------------|-----------------------|----------|----------------------------------------------|
| `paca_statusnotificationid`       | Uniqueidentifier (PK)| `string` (UUID)       | Auto     | Primary key                                  |
| `paca_requestid`                  | Lookup               | `string` (UUID)       | Yes      | FK → `paca_eventapprovalrequest`             |
| `paca_recipientid`                | String (100)         | `string`              | Yes      | Entra ID user object ID of recipient         |
| `paca_channel`                    | Choice               | `NotificationChannel` | Yes      | `in_app=0, email=1, teams=2`                |
| `paca_payload`                    | Multiline (4000)     | `NotificationPayload` | Yes     | Serialized as JSON string                    |
| `paca_deliverystatus`             | Choice               | `NotificationDeliveryStatus`| Yes| `queued=0, sent=1, failed=2`                |
| `paca_sentat`                     | DateTime             | `string \| null`      | No       | Nullable until delivery completes            |
| `createdon`                       | DateTime (system)    | `string`              | Auto     | Maps to `createdAt`                          |

## Choice Column Definitions

### paca_role (Global Choice: `paca_roletype`)
| Label       | Value |
|-------------|-------|
| Speaker     | 0     |
| Organizer   | 1     |
| Assistant   | 2     |

### paca_transportationmode (Global Choice: `paca_transportationmode`)
| Label  | Value |
|--------|-------|
| Air    | 0     |
| Rail   | 1     |
| Car    | 2     |
| Bus    | 3     |
| Other  | 4     |

### paca_status (Global Choice: `paca_requeststatus`)
| Label     | Value |
|-----------|-------|
| Draft     | 0     |
| Submitted | 1     |
| Approved  | 2     |
| Rejected  | 3     |

### paca_decisiontype (Global Choice: `paca_decisiontype`)
| Label    | Value |
|----------|-------|
| Approved | 0     |
| Rejected | 1     |

### paca_eventtype (Global Choice: `paca_historyeventtype`)
| Label              | Value |
|--------------------|-------|
| Submitted          | 0     |
| Approved           | 1     |
| Rejected           | 2     |
| Commented          | 3     |
| Notification Sent  | 4     |
| Stale Detected     | 5     |

### paca_actorrole (Global Choice: `paca_actorrole`)
| Label    | Value |
|----------|-------|
| Employee | 0     |
| Approver | 1     |
| System   | 2     |

### paca_channel (Global Choice: `paca_notificationchannel`)
| Label  | Value |
|--------|-------|
| In App | 0     |
| Email  | 1     |
| Teams  | 2     |

### paca_deliverystatus (Global Choice: `paca_notificationdeliverystatus`)
| Label  | Value |
|--------|-------|
| Queued | 0     |
| Sent   | 1     |
| Failed | 2     |

## Relationships

| Parent Table                    | Child Table                    | Relationship Type | Lookup Column on Child   |
|---------------------------------|-------------------------------|-------------------|--------------------------|
| `paca_eventapprovalrequest`     | `paca_approvaldecision`       | 1:N               | `paca_requestid`         |
| `paca_eventapprovalrequest`     | `paca_requesthistoryentry`    | 1:N               | `paca_requestid`         |
| `paca_eventapprovalrequest`     | `paca_statusnotification`     | 1:N               | `paca_requestid`         |

Lookups are associated on create (set the lookup column value in the create payload). No polymorphic lookups are used.

## State Transitions

### `paca_status` on `paca_eventapprovalrequest`

```text
draft (0) ──submit──▶ submitted (1)
submitted (1) ──approve──▶ approved (2)   [terminal]
submitted (1) ──reject──▶ rejected (3)    [terminal]
```

Invalid transitions are rejected at the app layer. Optimistic concurrency uses the `paca_version` integer field — the app reads `paca_version`, sends it with the decision, and rejects the operation if the stored version doesn't match.

## Type Mapping: App Domain ↔ Dataverse Columns

### `SubmitRequestInput` → `paca_eventapprovalrequest` (create)

| App Field                  | Dataverse Column          | Mapping Notes                          |
|----------------------------|---------------------------|----------------------------------------|
| `eventName`                | `paca_eventname`          | Direct                                 |
| `eventWebsite`             | `paca_eventwebsite`       | Direct                                 |
| `role`                     | `paca_role`               | Enum string → choice int               |
| `transportationMode`       | `paca_transportationmode` | Enum string → choice int               |
| `origin`                   | `paca_origin`             | Direct                                 |
| `destination`              | `paca_destination`        | Direct                                 |
| `costEstimate.registration`| `paca_registrationfee`    | Direct                                 |
| `costEstimate.travel`      | `paca_travelcost`         | Direct                                 |
| `costEstimate.hotels`      | `paca_hotelcost`          | Direct                                 |
| `costEstimate.meals`       | `paca_mealscost`          | Direct                                 |
| `costEstimate.other`       | `paca_otherexpenses`      | Direct                                 |
| `costEstimate.currencyCode`| `paca_currencycode`       | Direct                                 |
| `costEstimate.total`       | `paca_totalcost`          | Direct                                 |

System-managed fields (`paca_eventapprovalrequestid`, `createdon`, `modifiedon`) are excluded from create payloads.

### `paca_eventapprovalrequest` (read) → `EventApprovalRequest`

| Dataverse Column                  | App Field              | Mapping Notes                          |
|-----------------------------------|------------------------|----------------------------------------|
| `paca_eventapprovalrequestid`     | `requestId`            | Direct                                 |
| `paca_requestnumber`              | `requestNumber`        | Direct                                 |
| `paca_submitterid`                | `submitterId`          | Direct                                 |
| `paca_submitterdisplayname`       | `submitterDisplayName` | Direct                                 |
| `paca_eventname`                  | `eventName`            | Direct                                 |
| `paca_eventwebsite`               | `eventWebsite`         | Direct                                 |
| `paca_role`                       | `role`                 | Choice int → enum string               |
| `paca_transportationmode`         | `transportationMode`   | Choice int → enum string               |
| `paca_origin`                     | `origin`               | Direct                                 |
| `paca_destination`                | `destination`          | Direct                                 |
| `paca_registrationfee`            | `costEstimate.registration` | Assembled into CostEstimate       |
| `paca_travelcost`                 | `costEstimate.travel`  | Assembled into CostEstimate            |
| `paca_hotelcost`                  | `costEstimate.hotels`  | Assembled into CostEstimate            |
| `paca_mealscost`                  | `costEstimate.meals`   | Assembled into CostEstimate            |
| `paca_otherexpenses`              | `costEstimate.other`   | Assembled into CostEstimate            |
| `paca_currencycode`               | `costEstimate.currencyCode` | Assembled into CostEstimate       |
| `paca_totalcost`                  | `costEstimate.total`   | Assembled into CostEstimate            |
| `paca_status`                     | `status`               | Choice int → enum string               |
| `createdon`                       | `createdAt`            | ISO string                             |
| `modifiedon`                      | `updatedAt`            | ISO string                             |
| `paca_submittedat`                | `submittedAt`          | Nullable                               |
| `paca_version`                    | `version`              | Direct                                 |

## Security Model

### Dataverse Security Role: "Event Approver"

| Table                            | Create | Read                  | Update              | Delete |
|----------------------------------|--------|-----------------------|---------------------|--------|
| `paca_eventapprovalrequest`      | Own    | Organization-level    | Own status/version  | None   |
| `paca_approvaldecision`          | Own    | Organization-level    | None                | None   |
| `paca_requesthistoryentry`       | Own    | Organization-level    | None                | None   |
| `paca_statusnotification`        | None   | Own                   | None                | None   |

### Default User (Employee) Access

| Table                            | Create | Read | Update | Delete |
|----------------------------------|--------|------|--------|--------|
| `paca_eventapprovalrequest`      | Own    | Own  | None   | None   |
| `paca_approvaldecision`          | None   | Own  | None   | None   |
| `paca_requesthistoryentry`       | None   | Own  | None   | None   |
| `paca_statusnotification`        | None   | Own  | None   | None   |

Row-level security is enforced by Dataverse. The `submitterId` field determines ownership for employee access filtering.
