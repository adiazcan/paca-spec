# Implementation Plan: Dataverse Integration & Environment Data Strategy

**Branch**: `002-dataverse-integration` | **Date**: 2026-02-16 | **Spec**: `C:\github\paca-spec\specs\002-dataverse-integration\spec.md`
**Input**: Feature specification from `/specs/002-dataverse-integration/spec.md`

## Summary

Connect the Event Approval Workflow Code App to Microsoft Dataverse as the persistent data store for the dev environment. Provision four custom Dataverse tables (`paca_eventapprovalrequest`, `paca_approvaldecision`, `paca_requesthistoryentry`, `paca_statusnotification`) with embedded cost fields on the request table. Implement the `DataverseDataProvider` using Power Apps SDK generated services (via `pac code add-data-source -a dataverse -t <table>`). Resolve user identity from Entra ID via the Office 365 Users connector. Environment-based switching (`VITE_APP_DATA_MODE=mock|dataverse`) keeps local development fully mocked. Notifications are delivered through a Power Automate Cloud Flow triggered on request status changes, delivering Teams messages to submitters. Access is controlled by a Dataverse "Event Approver" security role with row-level security enforcing employee-only visibility of own requests.

## Technical Context

**Language/Version**: TypeScript 5.x, Node.js LTS (v20+), React 18  
**Primary Dependencies**: `@microsoft/power-apps` SDK, Power Platform CLI (PAC CLI 1.51.1+), PACX (`Greg.Xrm.Command`) for Dataverse schema provisioning, React, Vite, Vitest, Testing Library, Zod, Office 365 Users connector  
**Storage**: Dataverse custom tables (dev/prod); in-memory mock store + JSON fixtures (local)  
**Testing**: Vitest (unit/component), contract tests (OpenAPI schema compliance), integration tests (Dataverse CRUD via generated services), Playwright (smoke e2e)  
**Target Platform**: Power Apps Code Apps runtime (browser: Edge/Chrome), local `npm run dev` for development  
**Project Type**: Web application (single frontend delivered as Power Apps Code App)  
**Performance Goals**: Submit p95 < 5s Dataverse, dashboard load p95 < 5s, decision record p95 < 5s, history retrieval p95 < 3s, notification delivery < 120s  
**Constraints**: No direct Dataverse Web API calls **at runtime** (must use generated SDK services); table provisioning uses PACX CLI (`Greg.Xrm.Command`), a .NET global tool extending PAC CLI with schema provisioning commands; no `$batch` support in SDK (sequential writes); no polymorphic lookups; connection references for environment portability; same browser profile for local play + tenant auth  
**Scale/Scope**: Up to 2k employees, 200 approvers, 20k requests/year, 5 primary screens, 4 Dataverse custom tables

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

- **Code Quality Gate**: Enforce `eslint`, `prettier --check`, strict TypeScript (`tsc --noEmit`). PR merge blocked on lint/type failures. Dataverse provider code and mapping utilities must pass all quality checks. (FR-013)
- **Testing Gate**: Unit tests for type mapping functions (choice int ↔ enum string, Dataverse row ↔ app domain). Integration tests for each `DataverseDataProvider` method against Dataverse. Contract tests validating response shapes against OpenAPI spec. Regression tests for concurrency conflict detection. (FR-014)
- **UX Consistency Gate**: Reuse shared view-state pattern (`loading`, `empty`, `error`, `stale`) from `001`. Error states for Dataverse API failures follow existing UX patterns (retry button, user-friendly message). Permission denied state for non-approvers accessing approver dashboard. (FR-015)
- **Performance Gate**: Measurable p95 budgets per operation (see Technical Context). Validated via instrumented smoke runs before release. (FR-016)
- **Traceability Gate**: Each data model entity maps to FR-001..FR-003. Each provider method maps to FR-004..FR-005. Environment switching maps to FR-006. Identity maps to FR-007..FR-008. Notifications map to FR-009..FR-011. Concurrency maps to FR-012. Security role maps to FR-012a..FR-012b.

## Project Structure

### Documentation (this feature)

```text
specs/002-dataverse-integration/
├── plan.md              # This file
├── research.md          # Phase 0: Technology decisions and unknowns resolution
├── data-model.md        # Phase 1: Dataverse table schemas, choice columns, mappings
├── quickstart.md        # Phase 1: Setup and validation runbook
├── contracts/
│   └── dataverse-integration.openapi.yaml  # Phase 1: API contract v2
└── tasks.md             # Phase 2 output (NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
scripts/
└── provision-dataverse-tables.ps1  # PACX CLI provisioning (tables, columns, choices, relationships)

apps/event-approval-codeapp/
├── src/
│   ├── generated/            # Auto-generated by `pac code add-data-source`
│   │   ├── models/
│   │   │   ├── PacaEventapprovalrequestModel.ts
│   │   │   ├── PacaApprovaldecisionModel.ts
│   │   │   ├── PacaRequesthistoryentryModel.ts
│   │   │   ├── PacaStatusnotificationModel.ts
│   │   │   └── Office365UsersModel.ts
│   │   └── services/
│   │       ├── PacaEventapprovalrequestService.ts
│   │       ├── PacaApprovaldecisionService.ts
│   │       ├── PacaRequesthistoryentryService.ts
│   │       ├── PacaStatusnotificationService.ts
│   │       └── Office365UsersService.ts
│   ├── app/
│   ├── features/
│   │   ├── submit-request/
│   │   ├── approver-dashboard/
│   │   ├── request-history/
│   │   └── notifications/
│   ├── services/
│   │   ├── api-client/
│   │   │   ├── types.ts            # IDataProvider interface (unchanged)
│   │   │   ├── providerFactory.ts  # Mock/Dataverse switching (unchanged)
│   │   │   └── environment.ts      # DataMode resolver (unchanged)
│   │   ├── dataverse/
│   │   │   ├── dataverseDataProvider.ts  # Updated: wraps generated services
│   │   │   └── mappers.ts               # New: Dataverse ↔ app domain mappers
│   │   └── mocks/
│   │       └── mockDataProvider.ts       # Unchanged
│   ├── models/
│   │   └── eventApproval.ts        # Unchanged
│   └── validation/
│       └── schemas.ts              # Unchanged
├── tests/
│   ├── unit/
│   │   └── dataverse-mappers.test.ts     # New: type mapping tests
│   ├── integration/
│   │   └── dataverse-provider.integration.test.ts  # New: CRUD tests
│   ├── contract/
│   │   └── dataverse-contract.test.ts    # New: OpenAPI compliance
│   └── e2e/
│       └── event-approval.smoke.spec.ts  # Updated: Dataverse mode smoke
├── power.config.json     # Updated with connection/database references
├── package.json
└── vite.config.ts
```

**Structure Decision**: Maintain the existing frontend-focused web structure from `001`. The primary additions are: (1) `src/generated/` directory auto-created by PAC CLI when adding Dataverse data sources and the Office 365 Users connector, (2) `src/services/dataverse/mappers.ts` for explicit Dataverse ↔ app domain type conversion, and (3) new test files for mapper unit tests, Dataverse integration tests, and contract compliance tests.

## Post-Design Constitution Re-Check

- **Code Quality Gate**: PASS — Quality checks explicitly apply to new `mappers.ts`, updated `dataverseDataProvider.ts`, and all generated code dependencies. ESLint/Prettier/tsc rules from `001` carry over unchanged.
- **Testing Gate**: PASS — Unit tests for type mappers, integration tests for each `IDataProvider` method in Dataverse mode, contract tests against OpenAPI v2 spec, regression test for optimistic concurrency conflict.
- **UX Consistency Gate**: PASS — No new UX patterns introduced. Existing `loading`/`empty`/`error`/`stale` states are reused. New error states (Dataverse unavailable, permission denied) follow established patterns.
- **Performance Gate**: PASS — Measurable p95 budgets defined for all Dataverse operations. Validated in smoke runs.
- **Traceability Gate**: PASS — Every entity, mapper, provider method, and test traces to FR-001..FR-016 and User Stories 1–6 in the spec.

## Complexity Tracking

No constitution violations identified; no exceptions required.
